# Bloc global "events" — gère la manière dont NGINX traite les connexions
events {
    # Nombre maximal de connexions simultanées par processus de travail
    worker_connections 1024;
}

# Bloc principal HTTP — configure le comportement général du serveur web
http {
    # Inclut les types MIME pour que les fichiers aient les bons types (ex : .jpg = image/jpeg)
    include /etc/nginx/mime.types;
    
    # Type par défaut si le type MIME n'est pas trouvé
    default_type application/octet-stream;

    # Bloc "server" — configure un hôte virtuel (notre site WordPress ici)
    server {
        # Écoute les connexions HTTPS sur le port 443, avec support HTTP/2
        listen 443 ssl http2;
        
        # Nom de domaine du serveur (doit correspondre au certificat SSL et à l'entrée DNS)
        server_name jveirman.42.fr www.jveirman.42.fr;
        
        # Chemin vers le certificat SSL auto-signé
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;
        
        # Protocoles SSL/TLS autorisés (on force TLS 1.2 et 1.3 pour la sécurité)
        ssl_protocols TLSv1.2 TLSv1.3;
        
        # Répertoire racine contenant les fichiers de WordPress
        root /var/www/html/;
        
        # Fichier à servir en priorité (WordPress utilise uniquement index.php)
        index index.php;

        # Bloc par défaut pour toutes les requêtes
        location / {
            # NGINX essaie de trouver un fichier ou un dossier correspondant
            # Sinon, il redirige vers index.php (WordPress)
            try_files $uri $uri/ /index.php?$args;
        }

        # Bloc de traitement des fichiers PHP
        location ~ \.php$ {
            # Sécurité : vérifie que le fichier PHP existe réellement
            try_files $uri =404;
            
            # Découpe les chemins pour mieux gérer les paramètres (ex: fichier.php/param)
            fastcgi_split_path_info ^(.+\.php)(/.+)$;

            # Redirige les requêtes PHP vers le container WordPress (port 9000)
            fastcgi_pass wordpress:9000;

            # Fichier PHP par défaut à exécuter
            fastcgi_index index.php;

            # Inclut les paramètres FastCGI standards (ex: headers, environnements)
            include fastcgi_params;

            # Spécifie le fichier PHP à exécuter
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;

            # Paramètre complémentaire pour les chemins dynamiques
            fastcgi_param PATH_INFO $fastcgi_path_info;
        }
    }
}
